name: Java & AI CI/CD with Gradle

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 레포지토리 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Backend 빌드 ---
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
        working-directory: Backend

      - name: Build Backend with Gradle
        run: ./gradlew clean build -x test
        working-directory: Backend

      - name: Find Backend JAR
        id: find_jar
        run: |
          JAR_PATH=$(find Backend/build/libs -name "*.jar" ! -name "*-plain.jar" | head -n 1)
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT

      # --- EC2에 배포 ---

      # 7️⃣ Backend JAR 파일 복사
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: ${{ steps.find_jar.outputs.jar_path }}
          target: "/home/ubuntu/cicd/backend/"

      # 8️⃣ AI 폴더 내용물 복사
      - name: Copy AI folder contents to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "AI/*"
          target: "/home/ubuntu/cicd/ai"
          rm: true 

      # 9️⃣ EC2에서 서비스 재시작
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # 1. systemd가 새 서비스 파일 인식
            sudo systemctl daemon-reload
            
            # 2. (AI 앱) Python 패키지 설치
            cd /home/ubuntu/cicd/ai
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt # AI 폴더에 requirements.txt가 있다고 가정
            
            # 3. (AI 앱) AI 서비스 재시작
            sudo systemctl restart ai.service
            
            # 4. (Backend 앱) Backend 서비스 재시작
            sudo systemctl restart backend.service
            
            echo "🚀 2개 앱 배포 완료!"
