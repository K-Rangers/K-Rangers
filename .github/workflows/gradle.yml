name: Java & AI CI/CD with Gradle

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Backend ë¹Œë“œ ---
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
        working-directory: Backend

      - name: Build Backend with Gradle
        run: ./gradlew clean build -x test
        working-directory: Backend

      - name: Find Backend JAR
        id: find_jar
        run: |
          JAR_PATH=$(find Backend/build/libs -name "*.jar" ! -name "*-plain.jar" | head -n 1)
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT

      # --- EC2ì— ë°°í¬ ---

      # 7ï¸âƒ£ Backend JAR íŒŒì¼ ë³µì‚¬
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: ${{ steps.find_jar.outputs.jar_path }}
          target: "/home/ubuntu/cicd/backend/"

      # 8ï¸âƒ£ AI í´ë” ë‚´ìš©ë¬¼ ë³µì‚¬
      - name: Copy AI folder contents to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "AI/*"
          target: "/home/ubuntu/cicd/ai"
          rm: true 

      # 9ï¸âƒ£ EC2ì—ì„œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # 1. systemdê°€ ìƒˆ ì„œë¹„ìŠ¤ íŒŒì¼ ì¸ì‹
            sudo systemctl daemon-reload
            
            # 2. (AI ì•±) Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
            cd /home/ubuntu/cicd/ai
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt # AI í´ë”ì— requirements.txtê°€ ìˆë‹¤ê³  ê°€ì •
            
            # 3. (AI ì•±) AI ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            sudo systemctl restart ai.service
            
            # 4. (Backend ì•±) Backend ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            sudo systemctl restart backend.service
            
            echo "ğŸš€ 2ê°œ ì•± ë°°í¬ ì™„ë£Œ!"
